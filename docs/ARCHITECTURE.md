# Polimoney Hub アーキテクチャ設計

## 概要

Polimoney Hub は、Polimoney エコシステムのデータハブとして、以下の役割を担います：

1. **共通識別子の管理** - 政治家・政治団体・選挙の ID を一元管理
2. **データ連携の仲介** - Ledger と Polimoney 間のデータフローを制御
3. **匿名化処理** - プライバシー設定に基づくデータ変換
4. **キャッシュ** - 高頻度アクセスの最適化

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Polimoney Hub                                    │
│                         (Deno + Hono)                                    │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │
│  │ Politicians    │  │ Organizations  │  │ Elections      │            │
│  │ API            │  │ API            │  │ API            │            │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘            │
│          └───────────────────┼───────────────────┘                      │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     API Key 認証ミドルウェア                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     DB クライアント (postgres)                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬──────────────────────────────────────────┘
                               │
                               ▼
                   ┌───────────────────────┐
                   │ Azure PostgreSQL      │
                   │ (共通識別子マスタ)    │
                   │ - politicians         │
                   │ - organizations       │
                   │ - elections           │
                   └───────────────────────┘
```

---

## Polimoney エコシステム全体図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              DD2030 SaaS                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                        Polimoney Hub                              │  │
│  │  - 共通識別子管理 (政治家/政治団体/選挙)                          │  │
│  │  - データ連携・匿名化                                             │  │
│  │  - キャッシュ層                                                   │  │
│  └───────────────────────────┬──────────────────────────────────────┘  │
│                              │                                          │
│          ┌───────────────────┼───────────────────┐                     │
│          │                   │                   │                     │
│          ▼                   ▼                   ▼                     │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐            │
│  │ Polimoney     │   │ Azure DB      │   │ Polimoney     │            │
│  │ Ledger        │   │ (PostgreSQL)  │   │ (可視化)      │            │
│  │               │   │               │   │               │            │
│  │ ┌───────────┐ │   │ ┌───────────┐ │   │ ┌───────────┐ │            │
│  │ │ Supabase  │ │   │ │politicians│ │   │ │ Frontend  │ │            │
│  │ │ - Auth    │ │   │ │orgs       │ │   │ │ - 収支表示│ │            │
│  │ │ - DB      │ │   │ │elections  │ │   │ │ - 比較    │ │            │
│  │ │ - Storage │ │   │ └───────────┘ │   │ │ - 分析    │ │            │
│  │ └───────────┘ │   └───────────────┘   │ └───────────┘ │            │
│  └───────────────┘                       └───────────────┘            │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      将来の消費者                                 │  │
│  │  - 市民向けアプリ                                                 │  │
│  │  - 研究者向け API                                                 │  │
│  │  - メディア向けダッシュボード                                     │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## データフロー

### 1. 新規登録フロー（政治家 ID 発行）

```
ユーザー → Ledger → Hub → Azure DB
                          │
                          └→ 政治家 ID (UUID) を発行・保存
                          │
           ←──────────────┘
           政治家 ID を Ledger に返却
```

### 2. 仕訳データ連携（Realtime）

```
Ledger DB (Supabase)
     │
     │ Supabase Realtime (postgres_changes)
     ▼
Polimoney Hub
     │
     │ 匿名化処理 (is_name_private 等)
     │ キャッシュ更新
     ▼
Polimoney (可視化) / 他の消費者
```

### 3. データ取得フロー

```
Polimoney (可視化)
     │
     │ GET /api/v1/journals (予定)
     ▼
Polimoney Hub
     │
     ├─→ Azure DB: 政治家名・選挙情報を取得
     │
     └─→ Ledger DB (Supabase): 仕訳データを取得
            ※ 直接参照 or API 経由
```

---

## 技術スタック

| レイヤー | 技術 | 理由 |
|----------|------|------|
| ランタイム | Deno | TypeScript ネイティブ、セキュア |
| フレームワーク | Hono | 軽量、Edge 最適化 |
| DB クライアント | deno-postgres | Deno ネイティブ |
| ホスティング | Deno Deploy | グローバルエッジ、コールドスタート高速 |
| DB | Azure PostgreSQL | Polimoney との共有、地理的配置 |
| キャッシュ | Redis (Azure Cache) | 将来追加予定 |

---

## 認証・認可

### サービス間認証

| 通信 | 認証方式 |
|------|----------|
| Ledger → Hub | API Key + IP 制限 |
| Hub → Azure DB | 接続文字列 (SSL 必須) |
| Hub → Ledger DB | API Key または Supabase Service Role Key |
| Polimoney → Hub | API Key + IP 制限 |

### API Key 管理

```
環境変数:
- API_KEY: メイン API キー
- LEDGER_API_KEY: Ledger 専用キー（将来）
- POLIMONEY_API_KEY: Polimoney 専用キー（将来）
```

---

## ディレクトリ構成

```
polimoney_hub/
├── src/
│   ├── index.ts              # エントリポイント
│   ├── routes/
│   │   ├── politicians.ts    # 政治家 API
│   │   ├── organizations.ts  # 政治団体 API
│   │   ├── elections.ts      # 選挙 API
│   │   └── sync.ts           # Realtime 同期（予定）
│   ├── db/
│   │   └── client.ts         # DB 接続
│   ├── middleware/
│   │   └── auth.ts           # 認証
│   └── utils/
│       └── anonymize.ts      # 匿名化ロジック（予定）
├── db/
│   └── schema.sql            # Azure DB スキーマ
├── docs/
│   ├── API.md                # API 仕様
│   └── ARCHITECTURE.md       # 本ドキュメント
├── deno.json
└── README.md
```

---

## 今後の拡張

### Phase 1: 基盤構築 ✅
- [x] 政治家 / 政治団体 / 選挙 API
- [x] API Key 認証
- [x] Azure DB 接続

### Phase 2: Ledger 連携
- [ ] Supabase Realtime 受信エンドポイント
- [ ] 匿名化処理ロジック
- [ ] Ledger ↔ Hub API 連携

### Phase 3: Polimoney 連携
- [ ] 仕訳データ統合 API
- [ ] キャッシュ層 (Redis)
- [ ] 監査ログ

### Phase 4: 拡張
- [ ] 市民向けアプリ対応
- [ ] 研究者向け API
- [ ] OpenAPI / Swagger ドキュメント

